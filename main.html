<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />

        <title>Kasutajaliidesed</title>

        <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.2.js"> </script>
        <script type="text/javascript" src="http://cloud.github.com/downloads/SteveSanderson/knockout/knockout-2.0.0.debug.js"> </script>
        <script type="text/javascript" src="js/jquery.pagination.js"></script>
        <script type="text/javascript" src="js/pagination.js"></script>
        <script type="text/javascript" src="js/jquery.json-2.3.js"></script>
        <script type="text/javascript" src="js/jquery.dataprocessing.js"></script>

        <link rel="stylesheet" href="css/pagination.css" />
        <link rel="stylesheet" href="css/style.css"/>

        <script type="text/javascript">

            var todosJSON = [
                {"name":"TODO #1", "deadline":"12:00 13.04.2012", "description":"My fisrt todo. Hell yeah!",
                    "isUrgent":'checked="checked"',"isImportant":false,"isActive":'checked="checked"',"state":"Pending","tags":"bla bla bla"},
                {"name":"TODO #2", "deadline":"12:00 13.04.2012", "description":"My second todo. Hell yeah!",
                    "isUrgent":true,"isImportant":'checked="checked"',"isActive":'checked="checked"',"state":"Pending","tags":"bla bla bla"},
                {"name":"TODO #3", "deadline":"12:00 13.04.2012", "description":"My third todo. Hell yeah!",
                    "isUrgent":'checked="checked"',"isImportant":false,"isActive":'checked="checked"',"state":"Pending","tags":"bla bla bla"},
                {"name":"TODO #4", "deadline":"12:00 13.04.2012", "description":"My fourth todo. Hell yeah!",
                    "isUrgent":'checked="checked"',"isImportant":'checked="checked"',"isActive":'checked="checked"',"state":"Pending","tags":"bla bla bla"},
                {"name":"TODO #5", "deadline":"12:00 13.04.2012", "description":"My fifth todo. Hell yeah!",
                    "isUrgent":'checked="checked"',"isImportant":false,"isActive":'checked="checked"',"state":"Pending","tags":"bla bla bla"}
            ];

            $(document).ready(function() {

                // Shows / hides new todo addenum form
                var $newTodoDiv = $('div#new-todo'),
                $buttonTodoAdd = $('button#todo-add');
                $buttonTodoAdd.on('click', function() {
                    $newTodoDiv.toggle();
                    if ($buttonTodoAdd.text() == "Add TODO") {
                        $buttonTodoAdd.text('Cancel');
                    } else {
                        $buttonTodoAdd.text('Add TODO');
                    }
                });

                // Shows / hides advanced search form
                var $advancedSearchDiv = $('div#advanced-search-div'),
                $advancedSearchShow = $('button#advanced-search-show');
                $advancedSearchShow.on('click', function() {
                    $advancedSearchDiv.toggle();
                    if ($advancedSearchShow.text() == "Advanced search") {
                        $advancedSearchShow.text('Cancel');
                    } else {
                        $advancedSearchShow.text('Advanced search');
                    }
                });

                // Adds / removes tags to new todo
                $('div#todo-for-tags').on('click', 'span', function() {
                    $clickedSpan = $(this);
                    if($clickedSpan.attr('data-clicked') == 'false') {
                        $clickedSpan.attr('data-clicked', 'true')
                        .addClass('clicked')
                        .clone().attr('id', 'todo-tag-' + $clickedSpan.text())
                        .appendTo($('div#todo-for-tags-hidden'));
                    } else {
                        $clickedSpan.attr('data-clicked', 'false')
                        .removeClass('clicked');
                        $('span#todo-tag-' + $clickedSpan.text()).remove();
                    }
                });

                // TODO: Clears tags too fast, scrolling is bad
                $('button#addTodo').on('click', function() {
                    // $('div#todo-for-tags-hidden span').remove();
                    // $('div#todo-for-tags span').attr('data-clicked', 'false')
                    //     .removeClass('clicked');
                    // window.scrollTo($('span#jumpHere').offset().left, $('span#jumpHere').offset().top);
                });

                // Pins / unpins tags to new todo when they are checked
                var $divfortags = $('div#todo-for-tags'),
                $tag = $('div.tag-container');
                $tag.on('click', 'input[type="checkbox"]', function() {
                    if($(this).is(':checked')) {
                        $(this).siblings('span').clone()
                        .attr('id', 'todo-tag-' + $(this).siblings('span').text())
                        .appendTo($divfortags);
                    } else {
                        $('span#todo-tag-' + $(this).siblings('span').text()).remove();
                    }
                });

                // Shows / hides tag checkboxes
                var $deleteTags = $('#deleteTags');
                $('#deleteTags').on('click', function() {
                    if ($deleteTags.text() == "Edit") {
                        $deleteTags.text('Delete checked');
                        $('div.tag-container input[type="checkbox"]').removeClass('tag-checkbox-hidden');
                    } else {
                        $deleteTags.text('Edit');
                        $('div.tag-container input[type="checkbox"]').addClass('tag-checkbox-hidden');
                    }
                });

                function Tag(name, checked) {
                    return {
                        name : ko.observable(name),
                        isChecked : ko.observable(checked)
                    };
                }

                function appViewModel() {
                    var self = this;

                    // ======================================================
                    // == tag ViewModel
                    // ======================================================
                    // observable variables
                    self.tags =
                        ko.observableArray([
                        new Tag("school",false),
                        new Tag("birthday",false),
                        new Tag("meeting",false),
                        new Tag("work",false)
                    ]);

                    self.newTagName = ko.observable("");

                    // functions on observables
                    self.addTag = function () {
                        if (self.newTagName() != "")
                            self.tags.push(new Tag(self.newTagName(), false));
                    };

                    self.deleteTags = function() {
                        var selectedTags = $.grep(self.tags(), function(tag) {
                            return (tag.isChecked());
                        });

                        $(selectedTags).each( function(index, tag) {
                            self.tags.remove(tag);
                            $('span#todo-tag-' + tag.name()).remove();
                        });
                    };
                }

                ko.applyBindings(new appViewModel());

                $('#addTodo').on('click', function() {
                    var todo = {};

                    todo.isUrgent = $('input#urgent').attr('checked') ? 'checked="checked"' : '';
                    todo.isImportant = $('input#important').attr('checked') ? 'checked="checked"' : '';
                    todo.name = $('input#name').val();
                    todo.deadline = $('input#deadline').val();
                    todo.description = $('textarea#description').val();
                    todo.state = $('select#state').val();
                    todo.isActive = 'checked="checked"';
                    todo.tags = '';
                    $('div#todo-for-tags-hidden span').each(function() {
                        todo.tags += $(this).html() + ' ';
                    });

                    todosJSON.unshift(todo); //adds new items to the beginning of an array
                    displayTodos();

                });

                // init options
                var options = {
                    pagination : {
                        items_per_page: $('select#showOnPage').val(),
                        data_container: "#todo-wrapper"
                    },
                    dataprocessing : {
                        sort: false,
                        filter: false
                    }
                };
                // change options
                $('div#todo-display-settings').on('change', 'select', function() {
                    id = $(this).attr('id');
                    switch (id) {
                        case 'sortDir' :
                            options.dataprocessing.sort = true;
                            options.dataprocessing.sortDir = $(this).val();
                            break;
                        case 'sortBy' :
                            options.dataprocessing.sort = true;
                            options.dataprocessing.sortBy = $(this).val();
                            break;
                        case 'showOnPage' :
                            options.pagination.items_per_page = $(this).val();
                            break;
                    }
                    displayTodos();
                });

                $('button#search').on('click', function() {
                    options.dataprocessing.filter = true;
                    options.dataprocessing.filterCriteria = $('input#search-keyword').val();
                    displayTodos();
                });
                $('button#clear').on('click', function() {
                    options.dataprocessing.filter = false;
                    $('input#search-keyword').val('');
                    displayTodos();
                });

                function displayTodos() {
                    processedTodosJSON = $.processData(todosJSON, options.dataprocessing);
                    // Create pagination element with options from var
                    $("#Pagination").pagination(processedTodosJSON, options.pagination);
                }
                displayTodos();
            });
        </script>
    </head>
    <body>
        <div id="main-wrapper">
            <div id="header-wrapper">
                <div id="logo">
                    <a href="index.html" title="TODO">
                        <img src="img/logo.png" alt="TODO"/>
                    </a>
                </div>
            </div>
            <!--end header-wrapper-->

            <div id="content-wrapper">

                <div class="sign-out fineBox">
                    <form id="signout-form" action="index.html" method="post">
                        <span id="username-span">
                            <strong>User:</strong>
                            <span>Username</span>
                        </span>
                        <input type="hidden" name="login" value=""/>
                        <input type="submit" class="g-button g-button-submit" name="signOut" id="signOut" value="Sign out"/>
                    </form>
                </div> <!--end of sign-out -->

                <div class="right-panel">
                    <div class="tag-container fineBox" >
                        <h3>Tags</h3>
                        <ul data-bind="foreach: tags">
                            <li>
                                <input type="checkbox" class="tag-checkbox-hidden" data-bind="checked: isChecked" />
                                <span data-bind="text: name"></span>
                            </li>
                        </ul>
                        <input type="text" data-bind="value: newTagName" id="newtag" name="newtag" placeholder="New tag name..." />
                        <button data-bind="click: addTag" id="addtag" class="g-button g-button-submit" name="addtag">Add</button>
                        <button data-bind="click: deleteTags" id="deleteTags" class="g-button" name="deleteTags">Edit</button>
                    </div> <!--end of tag-container -->
                </div> <!--end of right-panel -->

                <div class="main">
                    <button name="todo-add" id="todo-add" class="g-button g-button-submit">Add TODO</button>
                    <div class="search-form">
                        <input type="text" id="search-keyword" name="search-keyword" placeholder="keyword" />
                        <button class="g-button g-button-submit" name="search" id="search">Search</button>
                        <button class="g-button g-button-submit" name="clear-search" id="clear">Clear</button>
                        <button class="g-button" name="advanced-search-show" id="advanced-search-show">Advanced search</button>
                    </div>

                    <div class="todo fineBox" id="advanced-search-div">
                        <h3>Advanced search</h3>
                        <input type="text" placeholder="keywords ..." />
                        <button class="g-button g-button-submit" name="advanced-search" id="advanced-search">Search</button>
                    </div>

                    <div class="todo fineBox" id="new-todo">
                        <h3 class="todo-heading">New TODO</h3>
                        <label>Type:</label>
                        <input id="urgent" type="checkbox" />urgent
                        <input id="important" type="checkbox" />important
                        <label>Name:</label><input id="name" type="text" />
                        <label>Deadline:</label><input id="deadline" type="text" />
                        <label>Description (optional): </label>
                        <textarea id="description" rows="4"></textarea>
                        <label>State:</label>
                        <select id="state" >
                            <option value="Undone">Undone</option>
                            <option value="In progress">In progress</option>
                            <option value="Pending">Pending</option>
                            <option value="Completed">Completed</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                        <label>Tags:</label>
                        <div id="todo-for-tags" data-bind="foreach: tags"><span data-bind="text: name" data-clicked="false"></span></div>
                        <div id="todo-for-tags-hidden" ></div>
                        <button  name="todo-submit" class="g-button g-button-submit" id="addTodo">Submit</button>
                    </div> <!--end of new-todo -->

                    <div>
                        <div id="todo-display-settings">
                            Show on page: <select id="showOnPage">
                                <option value="2">2</option>
                                <option value="5">5</option>
                                <option value="10">10</option>
                                <option value="20">20</option>
                                <option value="30">30</option>
                            </select>
                            Sort by: <select id="sortBy">
                                <option value="name">Name</option>
                                <option value="description">Description</option>
                                <option value="state">State</option>
                            </select>
                            <select id="sortDir">
                                <option value="ASC">ASC</option>
                                <option value="DESC">DESC</option>
                            </select>
                        </div>
                    </div>
                    <div id="Pagination" class="pagination"></div>

                    <div id="todo-wrapper"></div>

                    <span id="jumpHere"></span>
                </div><!--end of main -->

            </div> <!--end of content-wrapper-->

            <div id="footer-wrapper">
                <ul id="footer-container-right">
                    <li id="copyright">
                        Copyright © 2012
                        <a href="" title="// TODO:">// TODO:</a>
                        . All Rights Reserved
                    </li>
                    <!--end copyright-->
                    <li id="designed">
                        Designed by Nail Saberov & Dmitri Maksimov
                    </li>
                    <!--end designed -->
                </ul>
            </div> <!--end footer-wrapper-->

        </div><!--end main wrapper-->
    </body>
</html>
