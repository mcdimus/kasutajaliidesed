<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />

        <title>Kasutajaliidesed</title>

        <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.2.js"> </script>
        <script type="text/javascript" src="http://cloud.github.com/downloads/SteveSanderson/knockout/knockout-2.0.0.debug.js"> </script>
        <link rel="stylesheet" href="css/style.css"/>
    </head>
    <body>
        <div id="main-wrapper">
            <div id="header-wrapper">
                <div id="logo">
                    <a href="index.html" title="TODO">
                        <img src="img/logo.png" alt="TODO"/>
                    </a>
                </div>
                <div class="sign-out">
                    <form id="signout-form" action="index.html" method="post">
                        <div class="signout-div">
                            <span id="login-span">
                                User:
                                <strong class="login-label">Username</strong>
                            </span>
                            <input type="hidden" spellcheck="false" name="login" value=""/>
                        </div>
                        <input type="submit" class="g-button g-button-submit" name="signOut" id="signOut" value="Sign out"/>
                    </form>
                </div>
            </div>
            <!--end header-wrapper-->

            <div id="content-wrapper">
                <div class="tag-container" >
                    <h3>Tags</h3>
                    <ul data-bind="foreach: tags">
                        <li>
                            <input type="checkbox" data-bind="checked: isChecked" />
                            <span data-bind="text: name"></span>
                        </li>
                    </ul>
                    <button data-bind="click: deleteTags" id="deleteTags" class="g-button" name="deleteTags">Delete checked</button>
                    <input type="text" data-bind="value: newTagName" id="newtag" name="newtag" class="tag-area-inputs" placeholder="New tag name..." />
                    <button data-bind="click: addTag" id="addtag" class="g-button g-button-submit" name="addtag">Add</button>
                </div>

                <div class="main">
                    <div class="todo" id="new-todo">
                        <h3 class="todo-heading">New TODO</h3>
                        <label>Type:</label>
                        <input type="checkbox" data-bind="checked: newTodoUrgent"/>urgent</input>
                        <input type="checkbox" data-bind="checked: newTodoImportant"/>important</input>
                        <label>Name:</label><input type="text" data-bind="value: newTodoName"/>
                        <label>Deadline:</label><input type="text" data-bind="value: newTodoDeadline"/>
                        <label>Description (optional): </label>
                        <textarea data-bind="value: newTodoDescription" rows="4"></textarea>
                        <label>State:</label>
                        <select data-bind="value: newTodoState">
                            <option value="Undone">Undone</option>
                            <option value="In progress">In progress</option>
                            <option value="Pending">Pending</option>
                            <option value="Completed">Completed</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                        <label>Tags:</label><div id="todo-for-tags" data-bind="value: newTodoTags"></div>
                        <button data-bind="click: addTodo" name="todo-submit" class="g-button g-button-submit">Submit</button>
                    </div>
                    <button name="todo-add" id="todo-add" class="g-button g-button-submit">Add TODO</button>
                    
                    <span data-bind="foreach: todos" id="todo-wrapper">
                        <div class="todo">
                            <!-- TODO: rearrange and style elements -->
                            <h3 data-bind="text: name" class="todo-heading">TODO #1</h3>
                            <p> 
                                <input data-bind="checked: isUrgent" type="checkbox" name="todo-urgent">urgent</input>
                                <input data-bind="checked: isImportant" type="checkbox" name="todo-important">important</input>
                            </p>
                            <p>Deadline: <span data-bind="text: deadline"></span></p>
                            <p>Description: <span data-bind="text: description"></span></p>
                            <p>State: <span data-bind="text: state"></span></p>
                            <p>Tags: <span data-bind="text: tagsString()"></span></p>
                            <p> 
                                <input data-bind="checked: isActive" type="checkbox" name="todo-urgent">Active</input>
                            </p>
                        </div>
                    </span>
                </div>
                    <script type="text/javascript">
                        // Shows / hides new TODO addenum field
                        (function($) {
                                var newTodoDiv = $('div#new-todo');
                                var buttonTodoAdd = $('button#todo-add');
                                buttonTodoAdd.on('click', function() {
                                    newTodoDiv.slideToggle();
                                    if (buttonTodoAdd.text() == "Add TODO") {
                                        $(buttonTodoAdd).text('Cancel');
                                    } else {
                                        $(buttonTodoAdd).text('Add TODO');
                                    }
                                });                                
                            }
                        )(jQuery);


                        // Pins / unpins tags to new TODO when they are checked
                        $(function() {
                            var $divfortags = $('div#todo-for-tags');
                            var $tag = $('div.tag-container');
                            $tag.on('click', 'input[type="checkbox"]', function() {
                                if($(this).is(':checked')) {
                                   $(this).siblings('span').clone()
                                        .attr('id', 'todo-tag-' + $(this).siblings('span').text()).appendTo($divfortags);
                                } else {
                                    $('span#todo-tag-' + $(this).siblings('span').text()).remove();
                                }
                            });
                        });

                        function Tag(name, checked) {
                            return {
                                name : ko.observable(name),
                                isChecked : ko.observable(checked)
                            };
                        }

                        function Todo(name, urgent, important, deadline, description, state, tags, active) {
                            return {
                                name : ko.observable(name),
                                isUrgent : ko.observable(urgent),
                                isImportant : ko.observable(important),
                                deadline : ko.observable(deadline),
                                description : ko.observable(description),
                                state : ko.observable(state),
                                tags : ko.observableArray(tags),
                                isActive : ko.observable(active),
                                tagsString : function() {
                                    var string = '';
                                    $(tags).each( function(index, value) {
                                        string += value.name() + ' ';
                                    });
                                    return string;
                                }
                            };
                        }

                        function appViewModel() {
                            var self = this;

                            // ======================================================
                            // == tag ViewModel 
                            // ======================================================
                            // observable variables
                            self.tags =
                                ko.observableArray([
                                new Tag("school",false),
                                new Tag("birthday",false),
                                new Tag("meeting",false),
                                new Tag("work",false)
                            ]);

                            self.newTagName = ko.observable("");

                            // functions on observables
                            self.addTag = function () {
                                if (self.newTagName() != "")
                                    self.tags.push(new Tag(self.newTagName(), false));
                            };

                            self.deleteTags = function() {
                                var selectedTags = $.grep(self.tags(), function(tag) {
                                    return (tag.isChecked());
                                });

                                $(selectedTags).each( function(index, tag) {
                                    self.tags.remove(tag);
                                    $('span#todo-tag-' + tag.name()).remove();
                                });
                            };

                            // ======================================================
                            // == todo ViewModel 
                            // ======================================================
                            self.todos = 
                                ko.observableArray([
                                new Todo('TODO #1', false, true, '12:00 13.04.2012', 
                                        'My fisrt todo. Hell yeah!', 'Pending', 
                                        [new Tag("work",false), new Tag("school",false)], true),
                                new Todo('TODO #2', true, false, '12:00 13.04.2012', 
                                        'My second todo. Hell yeah!', 'Done', 
                                        [new Tag("birthday",false), new Tag("school",false)], false),
                                new Todo('TODO #3', true, true, '12:00 13.04.2012', 
                                        'My third todo. Hell yeah!', 'Undone', 
                                        [new Tag("work",false), new Tag("meeting",false)], true)
                                ]);

                            self.newTodoUrgent = ko.observable();
                            self.newTodoImportant = ko.observable();
                            self.newTodoName = ko.observable();
                            self.newTodoDeadline = ko.observable();
                            self.newTodoDescription = ko.observable();
                            self.newTodoState = ko.observable();
                            self.newTodoTags = ko.observable();

                            // TODO - tags addenum.

                            self.addTodo = function() {
                                self.todos.push(new Todo(self.newTodoName(), self.newTodoUrgent(), self.newTodoImportant(),
                                    self.newTodoDeadline(), self.newTodoDescription(), self.newTodoState(), [new Tag(self.newTodoTags(), false)],  false));
                            };
                        }

                        ko.applyBindings(new appViewModel());

                    </script>
            </div>
            <!--end content-wrapper-->
            <div id="footer-wrapper">
                <ul id="footer-container-right">
                    <li id="copyright">
                        Copyright © 2012
                        <a href="" title="// TODO:">// TODO:</a>
                        . All Rights Reserved
                    </li>
                    <!--end copyright-->
                    <li id="designed">
                        Designed by Dmitri Maksimov
                    </li>
                    <!--end designed -->
                </ul>
            </div>
            <!--end footer-wrapper-->
        </div>
        <!--end main wrapper-->
    </body>
</html>